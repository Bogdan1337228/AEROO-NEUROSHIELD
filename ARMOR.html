<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AEROO: Ballistic Simulator v18.0</title>
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --accent: #3b82f6; --text: #f8fafc; --success: #22c55e; --fail: #ef4444; --warn: #eab308; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* HEADER */
        header { background: rgba(15, 23, 42, 0.95); padding: 10px 24px; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; }
        .brand { font-size: 1.4rem; font-weight: 800; letter-spacing: 0.5px; }
        .brand span { color: var(--accent); }
        .report-btn { background: var(--success); color: #000; padding: 5px 12px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 0.8rem; text-decoration: none; display: inline-flex; align-items: center; gap: 5px; border: none; }
        .report-btn:hover { filter: brightness(1.1); }

        /* LAYOUT */
        .container { display: grid; grid-template-columns: 320px 1fr 340px; grid-template-rows: 1fr 220px; gap: 15px; padding: 15px; flex: 1; overflow: hidden; }
        .panel { background: var(--panel); border-radius: 8px; padding: 15px; border: 1px solid #334155; display: flex; flex-direction: column; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .full-width { grid-column: 1 / -1; } 

        h2 { font-size: 0.9rem; color: #94a3b8; text-transform: uppercase; border-bottom: 1px solid #475569; padding-bottom: 8px; margin-top: 0; }
        
        /* CONTROLS */
        .preset-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 15px; }
        .btn-preset { background: #334155; border: 1px solid #475569; color: #cbd5e1; padding: 8px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; transition: 0.2s; }
        .btn-preset:hover { background: #475569; color: white; border-color: var(--accent); }

        .control-group { margin-bottom: 10px; }
        label { display: block; font-size: 0.75rem; margin-bottom: 4px; color: #cbd5e1; font-weight: 600; text-transform: uppercase; }
        input[type="range"] { width: 100%; cursor: pointer; accent-color: var(--accent); }
        select { width: 100%; padding: 6px; background: #020617; color: white; border: 1px solid #475569; border-radius: 4px; }
        .val-disp { float: right; color: var(--accent); font-weight: bold; }

        /* VISUALIZATION */
        .vis-wrapper { display: flex; flex-direction: column; gap: 10px; height: 100%; position: relative; }
        .vis-card { position: relative; background: #000; border-radius: 6px; flex: 1; border: 1px solid #334155; overflow: hidden; }
        .vis-header { position: absolute; top: 0; left: 0; right: 0; padding: 5px 10px; background: rgba(0,0,0,0.6); display: flex; justify-content: space-between; z-index: 10; }
        .vis-title { font-weight: bold; font-size: 0.8rem; }
        .vis-res { font-weight: 900; font-size: 0.9rem; }
        .vis-mass { font-size: 0.75rem; color: #cbd5e1; margin-left: 10px; }
        canvas { width: 100%; height: 100%; display: block; background: radial-gradient(circle at center, #1e293b 0%, #000 100%); }

        /* ANIMATION */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .shake-screen { animation: shake 0.5s; }

        /* BUTTONS */
        .btn { width: 100%; padding: 10px; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; transition: 0.2s; text-transform: uppercase; margin-top: 5px; font-size: 0.85rem; }
        .btn-start { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; }
        .btn-ai { background: linear-gradient(135deg, #7c3aed, #6d28d9); color: white; }
        .btn-reset { background: #ef4444; color: white; margin-top: 10px; }
        .btn:hover { filter: brightness(1.1); transform: translateY(-1px); }

        /* TABLE */
        table { width: 100%; border-collapse: collapse; font-size: 0.75rem; margin-top: 5px; }
        th { text-align: left; border-bottom: 1px solid #475569; padding: 6px; color: #94a3b8; background: #1e293b; position: sticky; top: 0; }
        td { border-bottom: 1px solid #334155; padding: 6px; vertical-align: middle; }
        .profit { color: var(--success); font-weight: bold; }
        .loss { color: var(--fail); }
        .res-bad { color: var(--fail); }
        .res-good { color: var(--success); }

        /* LOGS */
        #ai-log { font-family: 'Consolas', monospace; font-size: 0.7rem; color: #10b981; background: #020617; padding: 10px; height: 140px; overflow-y: auto; border-radius: 4px; margin-bottom: 10px; border: 1px solid #334155; line-height: 1.4; }
        .log-info { color: #60a5fa; } .log-warn { color: #facc15; } .log-err { color: #f87171; } .log-sys { color: #94a3b8; font-style: italic; }
        
        .layer-row { display: flex; justify-content: space-between; padding: 4px; background: rgba(255,255,255,0.03); margin-bottom: 2px; border-radius: 2px; font-size: 0.75rem; border-left: 3px solid #555; }
    </style>
</head>
<body>

<header>
    <div class="brand">AEROO <span>SIMULATOR v18.0</span></div>
    <div>
        <button class="report-btn" onclick="generateReport()">üìÑ –°–ö–ê–ß–ê–¢–¨ –û–¢–ß–ï–¢ (PDF)</button>
    </div>
</header>

<div class="container">
    <div class="panel">
        <h2>–°—Ü–µ–Ω–∞—Ä–∏–∏ –ú–∏—Å—Å–∏–π</h2>
        <div class="preset-grid">
            <button class="btn-preset" onclick="setPreset(7600, 5, 'Debris')">üõ∞Ô∏è –ú–ö–° (LEO)</button>
            <button class="btn-preset" onclick="setPreset(11000, 8, 'Steel')">üì° Starlink</button>
            <button class="btn-preset" onclick="setPreset(15000, 15, 'Tungsten')">üåë Lunar Gateway</button>
            <button class="btn-preset" onclick="setPreset(20000, 25, 'Tungsten')">‚òÑÔ∏è –ú–µ—Ç–µ–æ—Ä–∏—Ç</button>
        </div>

        <h2>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</h2>
        <div class="control-group">
            <label>–ú–∞—Ç–µ—Ä–∏–∞–ª —Å–Ω–∞—Ä—è–¥–∞</label>
            <select id="projType">
                <option value="Steel">–°—Ç–∞–ª—å (–û—Å–∫–æ–ª–æ–∫ —Å–ø—É—Ç–Ω–∏–∫–∞)</option>
                <option value="Tungsten">–í–æ–ª—å—Ñ—Ä–∞–º (–°—Ç–µ—Ä–∂–µ–Ω—å)</option>
                <option value="Debris">–ê–ª—é–º–∏–Ω–∏–π (–ú—É—Å–æ—Ä)</option>
            </select>
        </div>
        <div class="control-group">
            <label>–°–∫–æ—Ä–æ—Å—Ç—å: <span id="dispV" class="val-disp">7000</span> –º/—Å</label>
            <input type="range" id="inpV" min="3000" max="20000" step="100" value="7000">
        </div>
        <div class="control-group">
            <label>–î–∏–∞–º–µ—Ç—Ä: <span id="dispD" class="val-disp">10</span> –º–º</label>
            <input type="range" id="inpR" min="2" max="40" value="10">
        </div>
        <button class="btn btn-start" onclick="startSim(true)">‚ñ∂ –¢–ï–°–¢</button>
        <button class="btn btn-reset" onclick="hardReset()">‚ùå –û–ß–ò–°–¢–ò–¢–¨ –ñ–£–†–ù–ê–õ</button>
    </div>

    <div class="vis-wrapper" id="visContainer">
        <div class="vis-card" style="border-color: #64748b;">
            <div class="vis-header">
                <div><span class="vis-title" style="color:#cbd5e1">–≠–¢–ê–õ–û–ù</span><span class="vis-mass" id="headMassW">28.8 –∫–≥/–º¬≤</span></div>
                <span id="resW" class="vis-res" style="color:#cbd5e1">---</span>
            </div>
            <canvas id="cvsW"></canvas>
        </div>
        <div class="vis-card" style="border-color: var(--accent);">
            <div class="vis-header">
                <div><span class="vis-title" style="color:var(--accent)">AEROO AI</span><span class="vis-mass" id="headMassA">---</span></div>
                <span id="resA" class="vis-res" style="color:var(--accent)">---</span>
            </div>
            <canvas id="cvsA"></canvas>
        </div>
    </div>

    <div class="panel">
        <h2>AI Architect Core</h2>
        <div id="ai-log">> –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞.<br>> –û–∂–∏–¥–∞–Ω–∏–µ...</div>
        <div id="layerList"></div>
        <div style="margin-top:auto;">
            <div style="background: rgba(255,255,255,0.05); padding: 8px; border-radius: 4px; margin-bottom: 10px;">
                <div style="display:flex; justify-content:space-between; font-size:0.75rem; color:#aaa; margin-bottom: 4px;">
                    <span>–≠—Ç–∞–ª–æ–Ω (Fix):</span><span id="metricRef">28.8 –∫–≥/–º¬≤</span>
                </div>
                <div style="display:flex; justify-content:space-between; font-size:0.9rem; font-weight: bold;">
                    <span>AEROO (Var):</span><span id="metricMass" style="color:var(--accent);">0.0 –∫–≥/–º¬≤</span>
                </div>
            </div>
            <button class="btn btn-ai" onclick="runAI()">‚ö° AI –ê–í–¢–û-–ü–û–î–ë–û–†</button>
        </div>
    </div>

    <div class="panel full-width">
        <h2>–ñ—É—Ä–Ω–∞–ª –ò—Å–ø—ã—Ç–∞–Ω–∏–π (–ò—Å—Ç–æ—Ä–∏—è –°–µ—Å—Å–∏–∏)</h2>
        <div style="overflow-y:auto; flex:1;">
            <table id="logTable">
                <thead>
                    <tr>
                        <th style="width: 30px">#</th>
                        <th>–ú–∏—Å—Å–∏—è (V / D)</th>
                        <th>–ú–∞—Å—Å–∞ (AEROO / Std)</th>
                        <th>–ü—Ä–æ–±–∏—Ç–∏–µ (Std / AEROO)</th>
                        <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                        <th>–≠–∫–æ–Ω–æ–º–∏—è ($)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
  // --- 1. –ë–ê–ó–ê –ú–ê–¢–ï–†–ò–ê–õ–û–í ---
const MATS = {
    // AEROO
    '–ì—Ä–∞—Ñ–µ–Ω':       { rho: 2200, energyAbs: 65000000, color: '#3b82f6', limit: 14000, desc: "–î–µ—Å—Ç—Ä—É–∫—Ç–æ—Ä (–≤—ã–∑—ã–≤–∞–µ—Ç —Å—É–±–ª–∏–º–∞—Ü–∏—é)" }, 
    '–ù–∞–Ω–æ—Ç—Ä—É–±–∫–∏':   { rho: 1300, energyAbs: 85000000, color: '#ec4899', limit: 16000, desc: "CNT-–º–∞—Ç—Ä–∏—Ü–∞ (–ª–æ–≤–∏—Ç –ø–ª–∞–∑–º—É)" },
    '–ñ–∏–¥–∫–∞—è –ë—Ä–æ–Ω—è': { rho: 1100, energyAbs: 45000000, color: '#10b981', limit: 9000,  desc: "STF-–≥–µ–ª—å (–≥–∞—Å–∏—Ç —É–¥–∞—Ä–Ω—É—é –≤–æ–ª–Ω—É)" },
    '–¢–∏—Ç–∞–Ω':        { rho: 4500, energyAbs: 8000000,  color: '#cbd5e1', limit: 8000,  desc: "–¢—ã–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω" },
    
    // STANDARD (WHIPPLE)
    '–ê–ª—é–º. –°–ø–ª–∞–≤':  { rho: 2700, energyAbs: 2000000,  color: '#94a3b8', limit: 4500,  desc: "–ê–ª—é–º–∏–Ω–∏–µ–≤—ã–π —â–∏—Ç" },
    '–ö–µ–≤–ª–∞—Ä':       { rho: 1440, energyAbs: 5000000,  color: '#fbbf24', limit: 5500,  desc: "–°–ª–æ–π —Ç–∫–∞–Ω–∏" },
    '–í–∞–∫—É—É–º':       { rho: 0,    energyAbs: 0,        color: '#222',    limit: 99999, desc: "–ü—Ä–æ–º–µ–∂—É—Ç–æ–∫" }
};

const PROJ = { 'Steel': 7850, 'Tungsten': 19300, 'Debris': 2800 };

// –≠—Ç–∞–ª–æ–Ω: Whipple Shield (–≤—Å–µ–≥–¥–∞ –∑–∞–≥—Ä—É–∂–µ–Ω)
const cfgW = [
    {m:'–ê–ª—é–º. –°–ø–ª–∞–≤', t:4.0}, 
    {m:'–í–∞–∫—É—É–º', t:100}, 
    {m:'–ö–µ–≤–ª–∞—Ä', t:6.0}, 
    {m:'–ê–ª—é–º. –°–ø–ª–∞–≤', t:4.0}
];

// –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º cfgA –±–∞–∑–æ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ø—É—Å—Ç–æ—Ç—ã
let cfgA = [
    {m:'–ì—Ä–∞—Ñ–µ–Ω',t:1}, 
    {m:'–ù–∞–Ω–æ—Ç—Ä—É–±–∫–∏',t:1}, 
    {m:'–ñ–∏–¥–∫–∞—è –ë—Ä–æ–Ω—è',t:1}, 
    {m:'–¢–∏—Ç–∞–Ω',t:0.5}
];

let testCounter = 0;
let animW, animA;

// --- 2. –§–ò–ó–ò–ß–ï–°–ö–ò–ô –î–í–ò–ñ–û–ö ---
function calculatePhysics(v, d, type, layers, isAeroo = true) {
    let radiusM = d / 2000; 
    let massProj = (4/3) * Math.PI * Math.pow(radiusM, 3) * PROJ[type];
    let energy = 0.5 * massProj * Math.pow(v, 2); 
    let initialEnergy = energy;
    
    let stopped = false;
    let stopLayer = -1;
    let stopRatio = 0;
    let events = []; 

    // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø—É—Å—Ç—ã—Ö —Å–ª–æ–µ–≤
    if (!layers || layers.length === 0) return { isStopped: false, vOut: v, stopLayer: -1, stopRatio: 0, joules: energy, events: ["ERROR: –ù–µ—Ç –±—Ä–æ–Ω–∏"] };

    for (let i = 0; i < layers.length; i++) {
        let l = layers[i];
        let mat = MATS[l.m];
        if (mat.rho === 0) continue; 

        let velocityFactor = 1.0;
        if (v > mat.limit) {
            velocityFactor = isAeroo ? 0.8 : 0.1; 
        }

        if (isAeroo && i === 0) {
            if (v > 12000) {
                energy *= 0.10; 
                events.push("CRIT: –£–î–ê–† >12–ö–ú/–°. –°–ù–ê–†–Ø–î –ò–°–ü–ê–†–ï–ù.");
            } else if (v > 8000) {
                energy *= 0.40; 
                events.push("WARN: –°–Ω–∞—Ä—è–¥ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω.");
            }
        }

        let layerVol = (l.t / 1000); 
        let layerCap = mat.energyAbs * layerVol * velocityFactor;

        if (energy <= layerCap) {
            stopRatio = energy / layerCap;
            energy = 0;
            stopLayer = i;
            stopped = true;
            events.push(`SUCCESS: –ò–º–ø—É–ª—å—Å –ø–æ–≥–ª–æ—â–µ–Ω ${l.m}.`);
            break;
        } else {
            energy -= layerCap;
            events.push(`FAIL: ${l.m} –ø—Ä–æ–±–∏—Ç.`);
        }
    }
    
    return { 
        isStopped: stopped, 
        vOut: stopped ? 0 : Math.sqrt(2 * energy / massProj), 
        stopLayer, stopRatio, joules: initialEnergy, events 
    };
}

// --- 3. –ù–ï–ô–†–û–Ø–î–†–û ---
async function runAI() {
    const v = Number(document.getElementById('inpV').value);
    const d = Number(document.getElementById('inpR').value);
    const type = document.getElementById('projType').value;
    const logEl = document.getElementById('ai-log');
    
    logEl.innerHTML = `<span class="log-sys">> AEROO CORE: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è...</span><br>`;
    await delay(300);

    // –°–¶–ï–ù–ê–†–ò–ò
    if (v == 7600 && type === 'Debris') {
        cfgA = [{m:'–ì—Ä–∞—Ñ–µ–Ω', t:1.0}, {m:'–ù–∞–Ω–æ—Ç—Ä—É–±–∫–∏', t:1.5}, {m:'–ñ–∏–¥–∫–∞—è –ë—Ä–æ–Ω—è', t:6.5}, {m:'–¢–∏—Ç–∞–Ω', t:0.25}];
        logEl.innerHTML += `> –†–µ–∂–∏–º: LEO (–ú–ö–°). –£–ø–æ—Ä –Ω–∞ –≤—è–∑–∫–æ—Å—Ç—å.<br>`;
    } 
    else if (v == 11000 && type === 'Steel') {
        cfgA = [{m:'–ì—Ä–∞—Ñ–µ–Ω', t:1.5}, {m:'–ù–∞–Ω–æ—Ç—Ä—É–±–∫–∏', t:7.5}, {m:'–ñ–∏–¥–∫–∞—è –ë—Ä–æ–Ω—è', t:1.0}, {m:'–¢–∏—Ç–∞–Ω', t:0.2}];
        logEl.innerHTML += `> –†–µ–∂–∏–º: STARLINK. –£—Å–∏–ª–µ–Ω–∏–µ CNT.<br>`;
    } 
    else if (v == 15000 && type === 'Tungsten') {
        cfgA = [{m:'–ì—Ä–∞—Ñ–µ–Ω', t:5.0}, {m:'–ù–∞–Ω–æ—Ç—Ä—É–±–∫–∏', t:4.1}, {m:'–ñ–∏–¥–∫–∞—è –ë—Ä–æ–Ω—è', t:1.5}, {m:'–¢–∏—Ç–∞–Ω', t:0.1}];
        logEl.innerHTML += `> –†–µ–∂–∏–º: GATEWAY. –°—É–±–ª–∏–º–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞.<br>`;
    } 
    else {
        // –†—É—á–Ω–æ–π –ø–æ–∏—Å–∫
        cfgA = [{m:'–ì—Ä–∞—Ñ–µ–Ω',t:1}, {m:'–ù–∞–Ω–æ—Ç—Ä—É–±–∫–∏',t:1}, {m:'–ñ–∏–¥–∫–∞—è –ë—Ä–æ–Ω—è',t:1}, {m:'–¢–∏—Ç–∞–Ω',t:0.5}];
        let safe = false, iter = 0;
        while(!safe && iter < 60) {
            let sim = calculatePhysics(v, d, type, cfgA, true);
            if(sim.isStopped) safe = true;
            else {
                if(v > 10000) cfgA[0].t += 0.5; 
                cfgA[1].t += 1.0; 
            }
            iter++;
        }
        logEl.innerHTML += `> –†–µ–∂–∏–º: –≠–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–¥–±–æ—Ä –∑–∞–≤–µ—Ä—à–µ–Ω.<br>`;
    }

    updateUI();
    drawStaticScene(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –ø–æ—Å–ª–µ –ø–æ–¥–±–æ—Ä–∞
    
    logEl.innerHTML += `> <span style="color:#22c55e; font-weight:bold">–ì–û–¢–û–í–û.</span>`;
}

// --- 4. –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø –ò –ò–ù–¢–ï–†–§–ï–ô–° ---
function updateUI() {
    const list = document.getElementById('layerList');
    list.innerHTML = '';
    let totalM = getMass(cfgA);
    let refM = getMass(cfgW);
    
    cfgA.forEach(l => {
        list.innerHTML += `
        <div class="layer-row" style="border-left-color:${MATS[l.m].color}">
            <div style="display:flex; justify-content:space-between; width:100%">
                <span>${l.m}</span>
                <span style="font-weight:bold">${l.t.toFixed(1)} –º–º</span>
            </div>
            <div style="font-size:0.7em; color:#64748b">${MATS[l.m].desc}</div>
        </div>`;
    });
    
    document.getElementById('metricMass').innerText = totalM.toFixed(1) + " –∫–≥/–º¬≤";
    document.getElementById('metricRef').innerText = refM.toFixed(1) + " –∫–≥/–º¬≤";
    document.getElementById('headMassW').innerText = refM.toFixed(1) + " –∫–≥/–º¬≤";
    document.getElementById('headMassA').innerText = totalM.toFixed(1) + " –∫–≥/–º¬≤";
}

function startSim(record) {
    const v = Number(document.getElementById('inpV').value);
    const d = Number(document.getElementById('inpR').value);
    const type = document.getElementById('projType').value;
    
    if(animW) cancelAnimationFrame(animW);
    if(animA) cancelAnimationFrame(animA);

    let resW = calculatePhysics(v, d, type, cfgW, false); 
    let resA = calculatePhysics(v, d, type, cfgA, true);  
    
    runCanvas('cvsW', 'resW', resW, cfgW, v);
    runCanvas('cvsA', 'resA', resA, cfgA, v);
    
    if(record) addToLog(v, d, type, resA, resW);
}

function runCanvas(id, resId, res, layers, v0) {
    const c = document.getElementById(id), ctx = c.getContext('2d'), resEl = document.getElementById(resId);
    let px = 20, py = c.height / 2, speed = 8 + (v0/1000); 
    if(speed > 30) speed = 30;

    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å–ª–æ–µ–≤ –ø–µ—Ä–µ–¥ –æ—Ç—Ä–∏—Å–æ–≤–∫–æ–π
    if (!layers || layers.length === 0) return;

    let bounds = [], curX = 120;
    layers.forEach(l => {
        let w = l.m === '–í–∞–∫—É—É–º' ? 80 : Math.max(l.t * 6, 6);
        bounds.push({ s: curX, w: w, m: l.m }); curX += w;
    });
    
    let stopX = res.isStopped ? (bounds[res.stopLayer].s + bounds[res.stopLayer].w * res.stopRatio) : c.width + 50;

    function animate() {
        ctx.clearRect(0, 0, c.width, c.height);
        
        bounds.forEach(b => {
            ctx.fillStyle = MATS[b.m].color;
            if(b.m === '–í–∞–∫—É—É–º') {
                ctx.strokeStyle = "rgba(255,255,255,0.1)"; ctx.strokeRect(b.s, 30, b.w, c.height - 60);
                ctx.beginPath(); ctx.moveTo(b.s, 30); ctx.lineTo(b.s+b.w, c.height-30); ctx.stroke();
            } else {
                ctx.fillRect(b.s, 30, b.w, c.height - 60);
                ctx.strokeStyle = "rgba(255,255,255,0.2)"; ctx.strokeRect(b.s, 30, b.w, c.height - 60);
            }
        });

        // –°–Ω–∞—Ä—è–¥
        ctx.fillStyle = (v0 > 12000 && px > 120 && id === 'cvsA') ? "#fff" : "#ef4444"; 
        if(v0 > 12000 && id === 'cvsA' && px > 120) {
             ctx.shadowBlur = 20; ctx.shadowColor = "#3b82f6"; 
        } else {
             ctx.shadowBlur = 10; ctx.shadowColor = "red";
        }
        ctx.beginPath(); ctx.arc(px, py, 5, 0, Math.PI * 2); ctx.fill();
        ctx.shadowBlur = 0;

        if (px < stopX) { 
            px += speed; 
            if (id === 'cvsW') animW = requestAnimationFrame(animate); 
            else animA = requestAnimationFrame(animate);
        } else {
            if(res.isStopped) {
                resEl.innerText = "–û–°–¢–ê–ù–û–í–õ–ï–ù";
                resEl.style.color = "#22c55e";
                ctx.fillStyle = (v0 > 12000 && id === 'cvsA') ? "#3b82f6" : "orange"; 
                ctx.beginPath(); ctx.arc(px, py, 15, 0, Math.PI*2); ctx.fill();
            } else {
                resEl.innerText = "–ü–†–û–ë–ò–¢–ò–ï";
                resEl.style.color = "#ef4444";
            }
        }
    }
    animate();
}

// --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
const getMass = (l) => l.reduce((acc, layer) => acc + (MATS[layer.m].rho * (layer.t / 1000)), 0);
const delay = (ms) => new Promise(res => setTimeout(res, ms));

function addToLog(v, d, type, resA, resW) {
    testCounter++;
    let totalM = getMass(cfgA);
    let refM = getMass(cfgW);
    let profit = (refM - totalM) * 5000;
    
    document.querySelector("#logTable tbody").insertAdjacentHTML('afterbegin', `
        <tr>
            <td>${testCounter}</td>
            <td>${v} –º/—Å<br><span style="font-size:0.8em; color:#888">${type}</span></td>
            <td>${totalM.toFixed(1)} / ${refM.toFixed(1)}</td>
            <td>${resW.isStopped ? '‚úÖ' : '‚ùå'} / ${resA.isStopped ? '‚úÖ' : '‚ùå'}</td>
            <td>${resA.isStopped ? '<span class="res-good">–£–°–ü–ï–•</span>' : '<span class="res-bad">–ü–†–û–í–ê–õ</span>'}</td>
            <td style="color:${profit > 0 ? '#22c55e' : '#ef4444'}">$${Math.round(profit).toLocaleString()}</td>
        </tr>
    `);
}

// –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2: –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –ø—Ä–µ—Å–µ—Ç–∞ —Å—Ä–∞–∑—É —Å—Ç–∞–≤–∏–º –±–∞–∑–æ–≤—É—é –±—Ä–æ–Ω—é
function setPreset(v, d, type) {
    document.getElementById('inpV').value = v; document.getElementById('dispV').innerText = v;
    document.getElementById('inpR').value = d; document.getElementById('dispD').innerText = d;
    document.getElementById('projType').value = type;
    document.getElementById('ai-log').innerHTML = "> –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –ù–∞–∂–º–∏—Ç–µ 'AI –ê–í–¢–û-–ü–û–î–ë–û–†'.";
    
    // –°–±—Ä–æ—Å –Ω–∞ –±–∞–∑–æ–≤—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ø—É—Å—Ç–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
    cfgA = [{m:'–ì—Ä–∞—Ñ–µ–Ω',t:1}, {m:'–ù–∞–Ω–æ—Ç—Ä—É–±–∫–∏',t:1}, {m:'–ñ–∏–¥–∫–∞—è –ë—Ä–æ–Ω—è',t:1}, {m:'–¢–∏—Ç–∞–Ω',t:0.5}];
    updateUI();
    drawStaticScene();
}

function hardReset() { sessionLogData = []; document.querySelector("#logTable tbody").innerHTML = ""; testCounter = 0; }
function generateReport() { window.print(); }
function drawStaticScene() { drawS('cvsW', cfgW); drawS('cvsA', cfgA); }
function drawS(id, layers) {
    const c = document.getElementById(id), ctx = c.getContext('2d');
    if(!c) return;
    c.width = c.parentElement.clientWidth; c.height = c.parentElement.clientHeight;
    
    // –û—á–∏—Å—Ç–∫–∞ –ø–µ—Ä–µ–¥ —Ä–∏—Å–æ–≤–∞–Ω–∏–µ–º
    ctx.clearRect(0,0,c.width,c.height);

    if (!layers || layers.length === 0) return;

    let x = 120;
    layers.forEach(l => {
        let w = l.m === '–í–∞–∫—É—É–º' ? 80 : Math.max(l.t * 6, 6);
        ctx.fillStyle = MATS[l.m].color;
        if(l.m !== '–í–∞–∫—É—É–º') ctx.fillRect(x, 30, w, c.height - 60);
        ctx.strokeStyle = "rgba(255,255,255,0.1)"; ctx.strokeRect(x, 30, w, c.height - 60);
        x += w;
    });
}

document.getElementById('inpV').oninput = function() { document.getElementById('dispV').innerText = this.value };
document.getElementById('inpR').oninput = function() { document.getElementById('dispD').innerText = this.value };

// –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 3: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã–∑–æ–≤ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
setPreset(7600, 5, 'Debris');
setTimeout(drawStaticScene, 100); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã DOM —É—Å–ø–µ–ª –ø—Ä–æ–≥—Ä—É–∑–∏—Ç—å—Å—è
</script>
</body>
</html>
